<button id="startButton">Start Camera + micro:bit</button>
<div id="status"></div>

<script>
let model, webcam, port, writer;

// Replace these with your actual Teachable Machine model URLs
const modelURL = "https://teachablemachine.withgoogle.com/models/Znxs4Qv-h/model.json";
const metadataURL = "https://teachablemachine.withgoogle.com/models/Znxs4Qv-h/metadata.json";

// Button click starts everything
document.getElementById("startButton").onclick = async function() {
  const status = document.getElementById("status");
  status.innerText = "Starting...";

  try {
    // 1️⃣ Setup the webcam
    webcam = new tmImage.Webcam(200, 200, true);
    await webcam.setup();   // Chrome will ask for camera permission
    await webcam.play();
    document.body.appendChild(webcam.canvas);

    // 2️⃣ Load the model
    model = await tmImage.load(modelURL, metadataURL);

    // 3️⃣ Connect to micro:bit via WebUSB / Serial
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    writer = port.writable.getWriter();

    status.innerText = "Running";

    // 4️⃣ Start the prediction loop
    window.requestAnimationFrame(loop);

  } catch (err) {
    console.error(err);
    status.innerText = "Error: " + err;
  }
}

// Prediction loop
async function loop() {
  // Update the webcam
  webcam.update();

  // Make a prediction
  const predictions = await model.predict(webcam.canvas);

  // Find the class with highest probability
  const best = predictions.reduce((a, b) =>
    a.probability > b.probability ? a : b
  );

  // Send the result to micro:bit
  if (best.className === "A") {
    await writer.write(new TextEncoder().encode("A\n"));
  } else if (best.className === "B") {
    await writer.write(new TextEncoder().encode("B\n"));
  }

  // Loop again
  window.requestAnimationFrame(loop);
}
</script>

