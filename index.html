<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Micro:bit + Teachable Machine</title>
  <!-- Load TensorFlow.js first -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.0.0"></script>
  <!-- Then load Teachable Machine Image library -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 20px; }
    #status { margin-top: 10px; font-weight: bold; }
    canvas { margin-top: 10px; }
    button { font-size: 18px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h1>Micro:bit + Teachable Machine</h1>
  <button id="startButton">Start Camera + micro:bit</button>
  <div id="status"></div>

  <script>
  let model, webcam, port, writer;

  // Your Teachable Machine model URLs
  const modelURL = "https://teachablemachine.withgoogle.com/models/6P7u4qnar/model.json";
  const metadataURL = "https://teachablemachine.withgoogle.com/models/6P7u4qnar/metadata.json";

  document.getElementById("startButton").onclick = async function() {
    const status = document.getElementById("status");
    status.innerText = "Starting...";

    try {
      // Wait until tmImage is fully loaded
      await new Promise(resolve => {
        if (tmImage && tmImage.Webcam) resolve();
        else {
          const interval = setInterval(() => {
            if (tmImage && tmImage.Webcam) {
              clearInterval(interval);
              resolve();
            }
          }, 50);
        }
      });

      // 1️⃣ Setup the webcam
      webcam = new tmImage.Webcam(200, 200, true);
      await webcam.setup();   // Chrome will ask for camera permission
      await webcam.play();
      document.body.appendChild(webcam.canvas);

      // 2️⃣ Load the Teachable Machine model
      model = await tmImage.load(modelURL, metadataURL);

      // 3️⃣ Connect to micro:bit via WebUSB/Serial
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      writer = port.writable.getWriter();

      status.innerText = "Running";

      // 4️⃣ Start the prediction loop
      window.requestAnimationFrame(loop);

    } catch (err) {
      console.error(err);
      status.innerText = "Error: " + err;
    }
  }

  // Prediction loop
  async function loop() {
    webcam.update();
    const predictions = await model.predict(webcam.canvas);

    // Find the class with the highest probability
    const best = predictions.reduce((a, b) =>
      a.probability > b.probability ? a : b
    );

    // Send result to micro:bit
    if (best.className === "A") await writer.write(new TextEncoder().encode("A\n"));
    else if (best.className === "B") await writer.write(new TextEncoder().encode("B\n"));

    window.requestAnimationFrame(loop);
  }
  </script>
</body>
</html>


